<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Location - Urban Eye</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnCoFaoW2ukBk6v9xPNFGzkuivCqeqq/bgZFGElxVjQ=="
            crossorigin=""></script>
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-app-background flex items-center justify-center min-h-screen p-4">
    <div class="urban-card-background p-8 md:p-12 rounded-card-lg shadow-card-soft max-w-md w-full text-center">
        <h2 class="text-2xl md:text-3xl font-bold mb-2 text-gray-800">Select Location</h2>
        <p class="text-md md:text-lg text-gray-600 mb-8">Pinpoint the exact location of the issue.</p>

        <div id="media-preview-container" class="mb-4 hidden">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Media Preview:</h3>
            <img id="media-preview-image" class="max-w-full h-auto rounded-lg shadow-md mx-auto hidden" alt="Complaint Media">
            <video id="media-preview-video" class="max-w-full h-auto rounded-lg shadow-md mx-auto hidden" controls></video>
        </div>

        <div id="map" class="w-full h-64 rounded-lg shadow-md mb-4"></div>
        <p id="coords-display" class="text-gray-700 mb-4">Latitude: --, Longitude: --</p>

        <div class="space-y-4">
            <button id="use-my-location-btn" class="w-full bg-action-blue text-white py-3 px-6 rounded-lg shadow-button-3d hover:scale-105 active:scale-95 transition-all font-semibold">
                Use My Current Location
            </button>
            <button id="submit-complaint-btn" class="w-full bg-action-green text-white py-3 px-6 rounded-lg shadow-button-3d hover:scale-105 active:scale-95 transition-all font-semibold">
                Submit Complaint
            </button>
        </div>
        <p id="status-message" class="mt-4 text-sm text-gray-700"></p>
    </div>

    <script>
        const mapElement = document.getElementById('map');
        const coordsDisplay = document.getElementById('coords-display');
        const useMyLocationBtn = document.getElementById('use-my-location-btn');
        const submitComplaintBtn = document.getElementById('submit-complaint-btn');
        const statusMessage = document.getElementById('status-message');
        const mediaPreviewContainer = document.getElementById('media-preview-container');
        const mediaPreviewImage = document.getElementById('media-preview-image');
        const mediaPreviewVideo = document.getElementById('media-preview-video');

        let map;
        let marker;
        let currentCoords = null;

        const backendBaseUrl = 'http://localhost:3001'; // Ensure this matches your backend port

        function initializeMap(lat = 0, lng = 0) {
            if (map) map.remove(); // Remove existing map if any
            map = L.map(mapElement).setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            marker.on('dragend', updateCoords);
            map.on('click', (e) => {
                marker.setLatLng(e.latlng);
                updateCoords();
            });
            updateCoords(); // Initial update
        }

        function updateCoords() {
            const latlng = marker.getLatLng();
            currentCoords = { lat: latlng.lat, lng: latlng.lng };
            coordsDisplay.textContent = `Latitude: ${latlng.lat.toFixed(6)}, Longitude: ${latlng.lng.toFixed(6)}`;
            console.log('Map coordinates updated:', currentCoords);
        }

        function useMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        map.setView([latitude, longitude], 16);
                        marker.setLatLng([latitude, longitude]);
                        updateCoords();
                        console.log('Geolocation successful:', { latitude, longitude });
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        statusMessage.textContent = 'Error getting location. Please enable location services or click on the map.';
                        statusMessage.style.color = 'red';
                    }
                );
            } else {
                console.error('Geolocation is not supported by this browser.');
                statusMessage.textContent = 'Geolocation is not supported by your browser.';
                statusMessage.style.color = 'red';
            }
        }

        async function submitComplaint() {
            const complaintData = JSON.parse(localStorage.getItem('tempComplaint'));

            if (!complaintData || !currentCoords) {
                statusMessage.textContent = 'Error: Complaint data or location missing.';
                statusMessage.style.color = 'red';
                console.error('Complaint data or location missing from localStorage or map.');
                return;
            }

            const payload = {
                category: complaintData.category,
                description: complaintData.description,
                fileUrl: complaintData.fileUrl,
                coords: currentCoords
            };

            console.log('Submitting complaint payload:', payload);

            try {
                const response = await fetch(`${backendBaseUrl}/api/complaints`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    statusMessage.textContent = 'âœ… Complaint submitted successfully! Redirecting...';
                    statusMessage.style.color = 'green';
                    console.log('Complaint submission successful:', data.message);
                    localStorage.removeItem('tempComplaint'); // Clean up
                    setTimeout(() => {
                        window.location.href = '/home'; // Redirect back to React app home
                    }, 2000);
                } else {
                    statusMessage.textContent = `Error: ${data.message}`;
                    statusMessage.style.color = 'red';
                    console.error('Complaint submission failed:', data.message);
                }
            } catch (error) {
                statusMessage.textContent = 'Network error. Could not submit complaint.';
                statusMessage.style.color = 'red';
                console.error('Network error during complaint submission:', error);
            }
        }

        function loadMediaPreview() {
            const complaintData = JSON.parse(localStorage.getItem('tempComplaint'));
            if (complaintData && complaintData.fileUrl) {
                mediaPreviewContainer.classList.remove('hidden');
                const fullFileUrl = complaintData.fileUrl.startsWith('/uploads') ? `${backendBaseUrl}${complaintData.fileUrl}` : complaintData.fileUrl;
                
                if (complaintData.isVideo) {
                    mediaPreviewVideo.src = fullFileUrl;
                    mediaPreviewVideo.classList.remove('hidden');
                    mediaPreviewImage.classList.add('hidden');
                    console.log('Displaying video preview:', fullFileUrl);
                } else {
                    mediaPreviewImage.src = fullFileUrl;
                    mediaPreviewImage.classList.remove('hidden');
                    mediaPreviewVideo.classList.add('hidden');
                    console.log('Displaying image preview:', fullFileUrl);
                }
            } else {
                mediaPreviewContainer.classList.add('hidden');
                console.log('No media to preview.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Default map view (e.g., a central location or user's last known)
            initializeMap(34.0522, -118.2437); // Default to Los Angeles for now

            useMyLocationBtn.addEventListener('click', useMyLocation);
            submitComplaintBtn.addEventListener('click', submitComplaint);

            loadMediaPreview();
        });
    </script>
</body>
</html>